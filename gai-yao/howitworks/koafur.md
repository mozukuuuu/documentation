# コアフロー

Connextのネットワークのフローは、スタックの流動性と転送層として[nxtp](https://github.com/connext/nxtp)ルーターを利用しています。一般的なクロスチェーンメッセージングを提供するためにAMBソリューションを構築しており、将来的には本格的な楽観的ブリッジソリューションにアップグレードするために状況を監視し続ける予定です。

すべては、クロスチェーン通信によるモジュール相互運用性の実現のために。

### コアフロー <a href="#core-flow" id="core-flow"></a>

<figure><img src="../../.gitbook/assets/IMG_2145.JPG" alt=""><figcaption></figcaption></figure>

Connextを経由するトランザクションは、以下のようなサイクルになります。

* ユーザーは、Connextコントラクトの`xcall`関数を呼び出し、資金、ガスの詳細、任意のデータ、およびターゲットアドレスオブジェクト（チェーン情報を含む）を渡して、取引を開始する。

{% hint style="warning" %}
_`xcallは`_solidityの下位コールを可能な限り模倣することを意図しています。
{% endhint %}

Connextの契約は、以下のようになります。

* 必要に応じて、渡されたトークンを同じアセットのAMBバージョンに交換します。
* トランザクションハッシュを持つAMBコントラクトを呼び出し、チェーン間で60分のメッセージレイテンシーを開始させる。
* トランザクションの詳細を示すイベントを発信する。

宛先チェーンに資金がある起点チェーンを観測しているルーターは、以下のようになります。

* トランザクションをシミュレートすることが前提である。(これが失敗した場合、これは認証を必要とする、より「表現力豊かな」クロスチェーンメッセージであるため、AMBを経由する必要がある)
* 受信チェーン上の資金を使用して署名されたトランザクションオブジェクトを準備する。
* このオブジェクト（「入札」）を競売人に掲示する。

{% hint style="warning" %}
_ルーターに十分な資金がない場合、転送額の一部のみを提供することも可能です。_
{% endhint %}

競売人は、基礎となるすべてのチェーンを監視します。X ブロックごとに、競売人はトランザクションの入札を収集します。競売人は、特定のトランザクションに対して正しいルーター (またはルーター!) を選択する責任があります (ランダムな場合もあります)。オークション主催者は、これらの入札のバッチをリレイヤー ネットワークに投稿して、チェーンに送信します。

ある入札がチェーンに提出されたとき、契約は次のように行われます。

* 取引に必要な資金が十分にあることを確認する。
* 必要に応じて、ルーターのAMB風味の資金をチェーンの正規の資産と交換する。
* スワップした資金を正しいターゲットに送る（コントラクトであれば、ターゲットに対して`calldataも`実行する）。
* ルーターのパラメータをハッシュ化し、このハッシュとルーターのアドレスのマッピングをコントラクトに格納します。

{% hint style="info" %}
この時点で、ユーザーのトランザクションはすでに完了しています。
{% endhint %}

その後、メッセージが到着すると、トランザクションを送信して、AMB 経由で受信したすべての保留中のハッシュを取得し、ハッシュ -> ルーター アドレス マッピングに対応するルーター アドレスがあるかどうかを調べることができます。その場合、AMB アセットが作成され、ルーターに渡されます。

{% hint style="warning" %}
もしルーターが間違った金額をユーザーに渡したり、間違ったcalldataを実行した場合、ルーターのハッシュはAMB経由で送られてくるハッシュと一致せず、ルーターは払い戻しを受けられなくなります。これは、ルーターが正しく動作することを保証するためのコアなセキュリティメカニズムである。

ルーターは取引中継の際、60分間の資金ロックアップを受けます。これは理論的には既存のシステムと比較して資本効率を低下させるが、実際にはリバランスの必要がないため、ルーターはより多くの資本をより頻繁に利用できることになる。
{% endhint %}
